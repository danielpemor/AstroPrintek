---
import BaseLayout from '../layouts/BaseLayout.astro';

const services = [
  'Compras Industriales',
  'Equipos de TI',
  'Logística Internacional',
  'Importaciones',
  'Consultoría',
  'Otro'
];
---

<BaseLayout title="Contacto - Printek" description="Contáctanos para obtener las mejores soluciones industriales y de TI. Estamos aquí para ayudarte.">
  <!-- Hero Section -->
  <section class="bg-gradient-to-r from-industrial-900 to-primary-800 text-white py-20 mt-20">
    <div class="container mx-auto px-4 lg:px-6">
      <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-5xl md:text-6xl font-heading font-bold mb-6">
          Contáctanos
        </h1>
        <p class="text-xl text-industrial-100 leading-relaxed">
          Estamos listos para ayudarte con tus necesidades industriales y de TI. 
          Hablemos sobre cómo podemos optimizar tu operación.
        </p>
      </div>
    </div>
  </section>

  <!-- Contact Form Section - White Background -->
  <section class="py-20 bg-white">
    <div class="container mx-auto px-4 lg:px-6">
      <div class="max-w-4xl mx-auto">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-heading font-bold text-slate-800 mb-6">
            Solicita tu Cotización
          </h2>
          <p class="text-lg text-slate-600">
            Completa el formulario y nos pondremos en contacto contigo en menos de 24 horas con una cotización personalizada.
          </p>
        </div>

<!-- Formulario -->
        <div class="bg-gradient-to-br from-slate-100 via-gray-50 to-blue-50 rounded-2xl shadow-xl p-8 border border-slate-200">
          <!-- Netlify Form con notificaciones configuradas desde código -->
          <form 
            name="contact" 
            method="POST" 
            data-netlify="true" 
            data-netlify-honeypot="bot-field"
            data-netlify-recaptcha="true"
            netlify-to="sales@printeksupplies.com"
            action="/gracias"
          >
            <!-- Netlify form detection -->
            <input type="hidden" name="form-name" value="contact" />
            
            <!-- Campo honeypot mejorado (múltiples trampas) -->
            <div style="display: none;">
              <label>No llenes esto si eres humano: 
                <input name="bot-field" tabindex="-1" autocomplete="off" />
              </label>
              <input name="website" type="url" style="display:none" />
              <input name="company-url" type="text" style="position:absolute;left:-9999px;" />
            </div>

            <!-- Timestamp oculto para detectar envíos muy rápidos -->
            <input type="hidden" name="timestamp" id="formTimestamp" />
            
            <!-- Campo de verificación de JavaScript -->
            <input type="hidden" name="js-enabled" value="false" id="jsEnabled" />

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <!-- Nombre -->
              <div>
                <label for="nombre" class="block text-sm font-semibold text-slate-700 mb-2">
                  Nombre Completo *
                </label>
                <input
                  type="text"
                  id="nombre"
                  name="nombre"
                  required
                  minlength="2"
                  maxlength="100"
                  pattern="[a-zA-ZÀ-ÿ\u00f1\u00d1\s]+"
                  class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300 bg-white"
                  placeholder="Tu nombre completo"
                  data-error-message="Por favor ingresa un nombre válido (solo letras, 2-100 caracteres)"
                />
                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
              </div>

              <!-- Email -->
              <div>
                <label for="email" class="block text-sm font-semibold text-slate-700 mb-2">
                  Email *
                </label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                  class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300 bg-white"
                  placeholder="tu@email.com"
                  data-error-message="Por favor ingresa un email válido"
                />
                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <!-- Teléfono -->
              <div>
                <label for="telefono" class="block text-sm font-semibold text-slate-700 mb-2">
                  Teléfono
                </label>
                <input
                  type="tel"
                  id="telefono"
                  name="telefono"
                  pattern="[\+]?[0-9\s\-\(\)]+"
                  minlength="10"
                  class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300 bg-white"
                  placeholder="+52 777 123 4567"
                  data-error-message="Por favor ingresa un número de teléfono válido (mínimo 10 dígitos)"
                />
                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
              </div>

              <!-- Empresa -->
              <div>
                <label for="empresa" class="block text-sm font-semibold text-slate-700 mb-2">
                  Empresa *
                </label>
                <input
                  type="text"
                  id="empresa"
                  name="empresa"
                  required
                  minlength="2"
                  maxlength="100"
                  class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300 bg-white"
                  placeholder="Nombre de tu empresa"
                  data-error-message="Por favor ingresa el nombre de tu empresa (2-100 caracteres)"
                />
                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <!-- Ubicación de la empresa -->
              <div>
                <label for="ubicacion" class="block text-sm font-semibold text-slate-700 mb-2">
                  Ubicación de tu Empresa *
                </label>
                <input
                  type="text"
                  id="ubicacion"
                  name="ubicacion"
                  required
                  minlength="2"
                  maxlength="100"
                  class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300 bg-white"
                  placeholder="Ciudad, Estado, País"
                  data-error-message="Por favor ingresa la ubicación de tu empresa"
                />
                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
              </div>

              <!-- Servicio de Interés -->
              <div>
                <label for="servicio" class="block text-sm font-semibold text-slate-700 mb-2">
                  Servicio de Interés *
                </label>
                <select
                  id="servicio"
                  name="servicio"
                  required
                  class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300 bg-white"
                  data-error-message="Por favor selecciona un servicio"
                >
                  <option value="">Selecciona un servicio</option>
                  <option value="Compras Industriales">Compras Industriales</option>
                  <option value="Equipos de TI">Equipos de TI</option>
                  <option value="Logística Internacional">Logística Internacional</option>
                  <option value="Importaciones">Importaciones</option>
                  <option value="Consultoría">Consultoría</option>
                  <option value="Otro">Otro</option>
                </select>
                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <!-- Número de Producto -->
              <div>
                <label for="numeroProducto" class="block text-sm font-semibold text-slate-700 mb-2">
                  Número de Producto
                  <span class="text-slate-500 font-normal">(Opcional)</span>
                </label>
                <input
                  type="text"
                  id="numeroProducto"
                  name="numeroProducto"
                  maxlength="50"
                  class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300 bg-white"
                  placeholder="Ej: HP-CF500A, DL380-GEN10"
                />
              </div>

              <!-- Marca y/o Modelo -->
              <div>
                <label for="marcaModelo" class="block text-sm font-semibold text-slate-700 mb-2">
                  Marca y/o Modelo
                  <span class="text-slate-500 font-normal">(Opcional)</span>
                </label>
                <input
                  type="text"
                  id="marcaModelo"
                  name="marcaModelo"
                  maxlength="100"
                  class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300 bg-white"
                  placeholder="Ej: HP LaserJet Pro, Dell PowerEdge"
                />
              </div>
            </div>

            <!-- Mensaje -->
            <div class="mb-6">
              <label for="mensaje" class="block text-sm font-semibold text-slate-700 mb-2">
                Descripción del Proyecto *
              </label>
              <textarea
                id="mensaje"
                name="mensaje"
                rows="4"
                required
                minlength="10"
                maxlength="1000"
                class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300 resize-y bg-white"
                placeholder="Describe tu proyecto, necesidades específicas, cantidad de productos, fecha estimada de entrega, etc..."
                data-error-message="Por favor describe tu proyecto (mínimo 10 caracteres)"
              ></textarea>
              <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
              <div class="text-sm text-slate-500 mt-1">
                <span id="charCount">0</span>/1000 caracteres
              </div>
            </div>

            <!-- reCAPTCHA -->
            <div class="mb-6 flex justify-center">
              <div data-netlify-recaptcha="true"></div>
            </div>

            <!-- Submit Button -->
            <div class="text-center">
              <button
                type="submit"
                id="submitBtn"
                disabled
                class="w-full bg-gray-400 cursor-not-allowed text-white px-8 py-4 rounded-lg font-semibold transition-all duration-300 inline-flex items-center justify-center"
              >
                <img src="/images/email.png" alt="email" class="w-5 h-5 mr-2" />
                <span id="submitText">Por favor espera...</span>
              </button>
            </div>

            <!-- Nota de privacidad -->
            <div class="mt-4 text-center text-sm text-slate-500">
              Al enviar este formulario, aceptas que procesemos tu información para responder a tu consulta.
              <br>
              <span class="text-xs">Protegido por reCAPTCHA y medidas anti-spam.</span>
            </div>
          </form>
        </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form[name="contact"]');
  const submitBtn = document.getElementById('submitBtn');
  const submitText = document.getElementById('submitText');
  const charCount = document.getElementById('charCount');
  const messageField = document.getElementById('mensaje');
  
  let formLoadTime = Date.now();
  let minTimeBeforeSubmit = 3000; // 3 segundos mínimo
  
  // Establecer timestamp y habilitar detección JS
  document.getElementById('formTimestamp').value = formLoadTime;
  document.getElementById('jsEnabled').value = 'true';
  
  // Contador de caracteres para mensaje
  if (messageField && charCount) {
    messageField.addEventListener('input', function() {
      const length = this.value.length;
      charCount.textContent = length;
      
      if (length > 1000) {
        charCount.parentElement.classList.add('text-red-500');
        charCount.parentElement.classList.remove('text-slate-500');
      } else {
        charCount.parentElement.classList.remove('text-red-500');
        charCount.parentElement.classList.add('text-slate-500');
      }
    });
  }
  
  // Habilitar botón de envío después del tiempo mínimo
  setTimeout(() => {
    submitBtn.disabled = false;
    submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
    submitBtn.classList.add('bg-primary-600', 'hover:bg-primary-700', 'hover:shadow-lg', 'transform', 'hover:-translate-y-1');
    submitText.textContent = 'Solicitar Cotización';
  }, minTimeBeforeSubmit);
  
  // Validación personalizada
  function validateField(field) {
    const errorDiv = field.parentElement.querySelector('.error-message');
    const errorMessage = field.dataset.errorMessage || 'Este campo es requerido';
    let isValid = true;
    
    // Remover estilos de error previos
    field.classList.remove('border-red-400');
    if (errorDiv) {
      errorDiv.textContent = '';
      errorDiv.classList.add('hidden');
    }
    
    // Validación de campo requerido
    if (field.hasAttribute('required') && !field.value.trim()) {
      isValid = false;
    }
    
    // Validación de email
    if (field.type === 'email' && field.value) {
      const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
      if (!emailRegex.test(field.value)) {
        isValid = false;
      }
    }
    
    // Validación de teléfono
    if (field.type === 'tel' && field.value) {
      const phoneRegex = /[\+]?[0-9\s\-\(\)]+/;
      if (!phoneRegex.test(field.value) || field.value.replace(/\D/g, '').length < 10) {
        isValid = false;
      }
    }
    
    // Validación de nombre (solo letras y espacios)
    if (field.id === 'nombre' && field.value) {
      const nameRegex = /^[a-zA-ZÀ-ÿ\u00f1\u00d1\s]+$/;
      if (!nameRegex.test(field.value)) {
        isValid = false;
      }
    }
    
    // Validación de longitud
    if (field.hasAttribute('minlength') && field.value.length < field.getAttribute('minlength')) {
      isValid = false;
    }
    
    if (field.hasAttribute('maxlength') && field.value.length > field.getAttribute('maxlength')) {
      isValid = false;
    }
    
    // Validación de select
    if (field.tagName === 'SELECT' && field.hasAttribute('required') && !field.value) {
      isValid = false;
    }
    
    // Mostrar error si es inválido
    if (!isValid) {
      field.classList.add('border-red-400');
      if (errorDiv) {
        errorDiv.textContent = errorMessage;
        errorDiv.classList.remove('hidden');
      }
    }
    
    return isValid;
  }
  
  // Validar al salir del campo
  const fields = form.querySelectorAll('input, select, textarea');
  fields.forEach(field => {
    field.addEventListener('blur', () => validateField(field));
    field.addEventListener('input', function() {
      if (this.classList.contains('border-red-400')) {
        validateField(this);
      }
    });
  });
  
  // Envío de formulario con protección anti-bot mejorada
  form.addEventListener('submit', function(e) {
    let isFormValid = true;
    
    // Validar todos los campos
    fields.forEach(field => {
      if (!validateField(field)) {
        isFormValid = false;
      }
    });
    
    // Protecciones anti-bot
    const timeTaken = Date.now() - formLoadTime;
    
    // Verificar si el formulario se envió muy rápido (probablemente un bot)
    if (timeTaken < minTimeBeforeSubmit) {
      e.preventDefault();
      alert('Por favor tómate tu tiempo para llenar el formulario correctamente.');
      return false;
    }
    
    // Verificar campos honeypot
    const honeypotField = form.querySelector('input[name="bot-field"]');
    const websiteField = form.querySelector('input[name="website"]');
    const companyUrlField = form.querySelector('input[name="company-url"]');
    
    if ((honeypotField && honeypotField.value) || 
        (websiteField && websiteField.value) || 
        (companyUrlField && companyUrlField.value)) {
      e.preventDefault();
      // Falla silenciosa para bots
      return false;
    }
    
    // Verificar si JavaScript está habilitado
    const jsField = document.getElementById('jsEnabled');
    if (!jsField || jsField.value !== 'true') {
      e.preventDefault();
      return false;
    }
    
    if (!isFormValid) {
      e.preventDefault();
      // Scroll al primer error
      const firstError = form.querySelector('.border-red-400');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstError.focus();
      }
      return false;
    }
    
    // Mostrar estado de carga
    submitBtn.innerHTML = '<img src="/images/email.png" alt="email" class="w-5 h-5 mr-2" />Enviando...';
    submitBtn.disabled = true;
  });
  
  // Formateo automático de teléfono
  const phoneField = document.getElementById('telefono');
  if (phoneField) {
    phoneField.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 0) {
        if (value.startsWith('1') && value.length <= 11) {
          // Formato USA: +1 (915) 307 2805
          value = value.replace(/(\d{1})(\d{3})(\d{3})(\d{4})/, '+$1 ($2) $3 $4');
        } else if (value.startsWith('52') && value.length <= 12) {
          // Formato México: +52 656 705 7931
          value = value.replace(/(\d{2})(\d{3})(\d{3})(\d{4})/, '+$1 $2 $3 $4');
        }
      }
      e.target.value = value;
    });
  }

  // Funcionalidad del mapa interactivo (corregir ubicación por defecto)
  const showMexicoBtn = document.getElementById('showMexico');
  const showUSABtn = document.getElementById('showUSA');
  const googleMap = document.getElementById('googleMap');

  // URLs de los mapas
  const mexicoMapURL = "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3368.234567!2d-106.4085409!3d31.709317!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x86e75d350dd9eda9%3A0xa1ef15cd701b0240!2sDacodex%20%7C%20Oficinas%20amuebladas!5e0!3m2!1sen!2smx!4v1702000000001!5m2!1sen!2smx";
  const usaMapURL = "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3370.0945673!2d-106.3072624!3d31.7465476!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x86e7437e05df51db%3A0xa3470ffb38cfb838!2sPrintek%20Supplies%20Inc!5e0!3m2!1sen!2smx!4v1702000000000!5m2!1sen!2smx";

  if (showMexicoBtn && showUSABtn && googleMap) {
    // Establecer México como ubicación por defecto al cargar
    googleMap.src = mexicoMapURL;
    
    showMexicoBtn.addEventListener('click', function() {
      googleMap.src = mexicoMapURL;
      // Resaltar botón activo
      showMexicoBtn.classList.remove('bg-red-100');
      showMexicoBtn.classList.add('bg-red-200', 'ring-2', 'ring-red-300');
      showUSABtn.classList.remove('bg-blue-200', 'ring-2', 'ring-blue-300');
      showUSABtn.classList.add('bg-blue-100');
    });

    showUSABtn.addEventListener('click', function() {
      googleMap.src = usaMapURL;
      // Resaltar botón activo
      showUSABtn.classList.remove('bg-blue-100');
      showUSABtn.classList.add('bg-blue-200', 'ring-2', 'ring-blue-300');
      showMexicoBtn.classList.remove('bg-red-200', 'ring-2', 'ring-red-300');
      showMexicoBtn.classList.add('bg-red-100');
    });

    // Establecer México como activo por defecto
    showMexicoBtn.classList.add('bg-red-200', 'ring-2', 'ring-red-300');
    showMexicoBtn.classList.remove('bg-red-100');
  }
});
</script>